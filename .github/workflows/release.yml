name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string
      create_tag:
        description: 'Create git tag for this version'
        required: true
        type: boolean
        default: true
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  PROJECT: MyTree.xcodeproj
  SCHEME: MyTree
  BUILD_DIR: ./build

jobs:
  validate:
    name: Validate Release
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          bundle install
          npm install -g markdownlint-cli2 cspell markdown-link-check
          brew install swiftlint

      - name: Run linting
        run: bundle exec fastlane lint

      - name: Run tests
        run: bundle exec fastlane test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/fastlane-test-results

  build-artifacts:
    name: Build Release Artifacts
    runs-on: macos-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build all artifacts
        run: bundle exec fastlane build_all version:${{ steps.version.outputs.version }}

      - name: List artifacts
        run: |
          echo "Built artifacts:"
          ls -lh build/Build/Products/Release/ || true
          ls -lh build/cli/ || true
          ls -lh dist/ || true

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: MyTree-macOS-DMG
          path: dist/*.dmg
          retention-days: 90

      - name: Upload CLI tool
        uses: actions/upload-artifact@v4
        with:
          name: mytree-cli
          path: build/cli/mytree
          retention-days: 90

      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: MyTree-macOS-app
          path: build/Build/Products/Release/MyTree.app
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: macos-latest
    needs: build-artifacts
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_tag == 'true')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Download DMG
        uses: actions/download-artifact@v4
        with:
          name: MyTree-macOS-DMG
          path: dist

      - name: Download CLI tool
        uses: actions/download-artifact@v4
        with:
          name: mytree-cli
          path: cli

      - name: Prepare release assets
        run: |
          # Rename CLI for release
          mv cli/mytree cli/mytree-macos-${{ steps.version.outputs.tag }}
          chmod +x cli/mytree-macos-${{ steps.version.outputs.tag }}

          # Create checksums
          cd dist
          shasum -a 256 *.dmg > checksums.txt
          cd ..
          cd cli
          shasum -a 256 mytree-macos-* >> ../dist/checksums.txt
          cd ..

          echo "Release assets:"
          ls -lh dist/
          ls -lh cli/
          cat dist/checksums.txt

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release_notes.md
          ## ðŸ“¦ Installation

          ### macOS App (Recommended)
          1. Download `MyTree-${{ steps.version.outputs.version }}.dmg`
          2. Open the DMG file
          3. Drag MyTree.app to your Applications folder
          4. Right-click the app and select "Open" (first launch only)

          ### CLI Tool
          1. Download `mytree-macos-${{ steps.version.outputs.tag }}`
          2. Make it executable: `chmod +x mytree-macos-${{ steps.version.outputs.tag }}`
          3. Move to PATH: `sudo mv mytree-macos-${{ steps.version.outputs.tag }} /usr/local/bin/mytree`
          4. Usage: `mytree --vcf contacts.vcf --output tree.png`

          ## ðŸ” Checksums

          ```
          $(cat dist/checksums.txt)
          ```

          ## âš ï¸ Security Note
          On first launch, macOS may show a security warning because the app is not notarized. To open:
          1. Right-click the app and select "Open"
          2. Click "Open" in the security dialog

          This app is built from open source and is safe to use.

          ## ðŸ“ What's New

          See the full changelog below for all changes in this release.
          EOF

          echo "Release notes generated"

      - name: Create or update tag (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and push tag
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: MyTree ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          generate_release_notes: true
          files: |
            dist/*.dmg
            dist/checksums.txt
            cli/mytree-macos-*

  notify:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [validate, build-artifacts, create-release]
    if: always()
    steps:
      - name: Build summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Artifacts | ${{ needs.build-artifacts.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create Release | ${{ needs.create-release.result == 'success' && 'âœ… Published' || needs.create-release.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate.result }}" = "success" ] && \
             [ "${{ needs.build-artifacts.result }}" = "success" ] && \
             [ "${{ needs.create-release.result }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Release completed successfully!**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.create-release.result }}" = "skipped" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ Artifacts built but release was not published (manual trigger without tag creation)." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Release workflow encountered errors. Check the logs above.**" >> $GITHUB_STEP_SUMMARY
          fi
